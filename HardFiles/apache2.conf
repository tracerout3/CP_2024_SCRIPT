#!/bin/bash

# Apache2 Hardening
# Disable unnecessary modules
a2dismod status
a2dismod autoindex
a2dismod userdir
# Disable directory listing
echo "Options -Indexes" >> /etc/apache2/apache2.conf
# Disable server signature and server tokens
echo "ServerSignature Off" >> /etc/apache2/apache2.conf
echo "ServerTokens Prod" >> /etc/apache2/apache2.conf
# Restrict access to server-status
echo "<Location /server-status>
    SetHandler server-status
    Require ip 127.0.0.1
</Location>" >> /etc/apache2/apache2.conf
# Limit allowed HTTP methods
echo "LimitRequestMethods GET POST" >> /etc/apache2/apache2.conf
# Restrict access to sensitive files
echo "<DirectoryMatch \"(^/|\./)?\.(ht|git|svn|bzr|hg)\">
    Require all denied
</DirectoryMatch>" >> /etc/apache2/apache2.conf
systemctl restart apache2

# Apache Tomcat Hardening
sed -i 's/Server\.XML/Server\.xml-disabled/' /opt/tomcat/conf/server.xml
sed -i 's/8005/8050/' /opt/tomcat/conf/server.xml
sed -i 's|<Context docBase="webapps" path="/" reloadable="true" crossContext="true" >|<Context docBase="webapps" path="/" reloadable="true" crossContext="false" >|' /opt/tomcat/conf/context.xml
sed -i 's|<Host name="localhost" appBase="webapps" unpackWARs="true" autoDeploy="true">|<Host name="localhost" appBase="/opt/tomcat/secured" unpackWARs="false" autoDeploy="false">|' /opt/tomcat/conf/server.xml
systemctl restart tomcat

# Bind9 Hardening
echo "options {
    recursion no;
    allow-query { any; };
};" > /etc/bind/named.conf.options
echo "allow-transfer { none; };" >> /etc/bind/named.conf.options
echo "allow-query { 127.0.0.1; };" >> /etc/bind/named.conf.options
systemctl restart bind9

# CIFS Utils Hardening (Samba)
echo "client min protocol = SMB2" >> /etc/samba/smb.conf
echo "server min protocol = SMB2" >> /etc/samba/smb.conf
echo "valid users = smbuser1, smbuser2" >> /etc/samba/smb.conf
systemctl restart smbd

# ClamAV Daemon Hardening
echo "ScanMail no" >> /etc/clamav/clamd.conf
echo "ScanArchive no" >> /etc/clamav/clamd.conf
echo "MaxFiles 5000" >> /etc/clamav/clamd.conf
echo "User clamav" >> /etc/clamav/clamd.conf
systemctl restart clamav-daemon

# Cockpit Hardening
echo "ListenStream=127.0.0.1:9090" >> /etc/systemd/system/cockpit.socket.d/override.conf
systemctl restart cockpit.socket

# Cron Hardening
chmod 700 /var/spool/cron/crontabs
echo "cron.*               /var/log/cron.log" >> /etc/rsyslog.conf
systemctl restart cron

# CUPS Hardening
echo "Listen localhost:631" >> /etc/cups/cupsd.conf
echo "BrowseRemoteProtocols none" >> /etc/cups/cupsd.conf
echo "Allow @LOCAL" >> /etc/cups/cupsd.conf
systemctl restart cups

# DBus Hardening
echo "[Policy]" > /etc/dbus-1/system.d/disable.conf
echo "deny all" >> /etc/dbus-1/system.d/disable.conf
systemctl restart dbus

# Docker Hardening
groupadd docker
usermod -aG docker trusteduser
echo "DOCKER_OPTS=\"--bip=192.168.1.5/24\"" >> /etc/default/docker
systemctl restart docker

# Dovecot Hardening
echo "disable_plaintext_auth = yes" >> /etc/dovecot/dovecot.conf
echo "listen = 127.0.0.1" >> /etc/dovecot/dovecot.conf
systemctl restart dovecot

# Exim4 Hardening
echo "deny hosts = !" >> /etc/exim4/exim4.conf.template
systemctl restart exim4

# Fail2Ban Hardening
systemctl enable fail2ban
systemctl start fail2ban
echo "[sshd]" >> /etc/fail2ban/jail.local
echo "enabled = true" >> /etc/fail2ban/jail.local

# FTP (vsftpd) Hardening
echo "anonymous_enable=NO" >> /etc/vsftpd.conf
echo "chroot_local_user=YES" >> /etc/vsftpd.conf
systemctl restart vsftpd

# IMAPD (Dovecot) Hardening
echo "disable_plaintext_auth = yes" >> /
